{% extends 'core/base.html' %}

{% block content %}

<div class="row">
  <div class="col-lg-8 col-md-10 col-sm-12 mx-auto shadow chat-box rounded">
    <div class="row inner">
      <div class="col-lg-4" style="position: relative;">

        {% include 'core/user-list.html' %}
      </div>
      <div class="col-lg-8 chat px-3">
        <div style="background:red">
          <img id="sender-profile-photo" src="../../media/{{ user.profile.image }}" alt="Sender Profile Photo"
            style="width: 50px; height: 50px; border-radius: 50%;" />
          <span>{{user.username}}</span>
          <!-- <div class="chat-header clearfix">
            <div class="row">
              <div class="col-lg-6">
                <a href="" data-toggle="modal" data-target="#view_info">
                  <img src="https://bootdey.com/img/Content/avatar/avatar2.png" alt="avatar">
                </a>
                <div class="chat-about">
                  <h6 class="m-b-0">Aiden Chavez</h6>
                  <small>Last seen: 2 hours ago</small>
                </div>
              </div>
            </div> -->
          <!-- </div> -->
        </div>
        <div id="chat-log" class="chat-log scroll">
          {% for chat in chats %}
          <div class="message mb-2 {% if chat.sender == request.user %}right{% else %}left{% endif %}">
            <div class="avatar" data-user="{{ chat.sender.username }}">{{chat.sender.username|first|upper}}</div>
            <span title="{{chat.timestamp}}" class="d-block pb-1 pr-0 m-0">{{chat.message}}
              <span class="timestamp px-0"
                style="font-size: x-small;color:gray;margin-left: 10px;">{{chat.timestamp|time:"H:i"}}</span>
            </span>
          </div>
          {% endfor %}
        </div>
        <form method="post" class="input-box d-flex w-100">
          {% csrf_token %}
          <input type="text" id="chat-message-input" class="form-control" name="" id="">
          <button id="chat-message-submit" type="submit">Send</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block extra_js %}

<script>

  let chatLog = document.getElementById('chat-log');
  let messageInput = document.getElementById('chat-message-input');
  let messageSubmit = document.getElementById('chat-message-submit');
  let lastMessage = document.getElementById('last-message');
  let roomName = "{{room_name}}";
  let user = "{{request.user.username}}"
  function scrollToBottom() {
    chatLog.scrollTop = chatLog.scrollHeight;
  }


  const chatSocket = new WebSocket(
    `ws://${window.location.host}/ws/chat/${roomName}/`
  )

  chatSocket.onmessage = e => {
    const data = JSON.parse(e.data);
    var html = `
      <div class="message mb-2 ${data.sender === user ? 'right' : 'left'}">
        <div class="avatar">${data.sender[0].toUpperCase()}</div>
        <span class="d-block">${data.message}</span>
      </div>
    `;
    chatLog.insertAdjacentHTML("beforeend", html);
    lastMessage
    scrollToBottom();
  }

  chatSocket.onclose = e => {
    console.error('Chat socket closed unexpectedly');
  }

  messageSubmit.disabled = true;
  messageInput.addEventListener('input', function () {
    if (messageInput.value.trim() !== '') {
      messageSubmit.disabled = false;
    } else {
      messageSubmit.disabled = true;
    }
  })

  messageInput.focus();
  messageSubmit.onclick = e => {
    e.preventDefault();

    const message = messageInput.value;
    if (message != "") {
      chatSocket.send(JSON.stringify({
        'message': message
      }));
      messageInput.value = '';
    }
  }
  chatLog.addEventListener('scroll', function () {
    chatLog.classList.add('scroll');
  });
  setTimeout(function () {
    chatLog.classList.remove('scroll');
  }, 1000);


</script>

{% endblock extra_js %}